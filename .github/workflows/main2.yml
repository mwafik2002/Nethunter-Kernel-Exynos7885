
  name: Build Kernel (A30s)

  on:
    workflow_dispatch:
    push:
      tags:
        - "v*"

  jobs:
    build:
      runs-on: ubuntu-22.04
      env:
        ARCH: arm64
        SUBARCH: arm64
        DEFCONFIG: exynos7885-a30s_defconfig
        KERNEL_NAME: Nethunter-A30s-Exynos7885
        BOOT_BLOCK: /dev/block/mmcblk0p15
        DTB_BLOCK: /dev/block/mmcblk0p17
        DTBO_BLOCK: /dev/block/mmcblk0p18

      steps:
        - name: Checkout kernel source
          uses: actions/checkout@v4

        - name: Install dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y \
              bc bison build-essential ccache curl flex git libssl-dev \
              libelf-dev lz4 make python3 rsync unzip zip zstd

        - name: Clone toolchains
          run: |
            mkdir -p toolchains
            git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9.git toolchains/gcc
           

        - name: Build kernel
          run: |
            export PATH="${GITHUB_WORKSPACE}/toolchains/proton-clang/bin:${PATH}"
            export CROSS_COMPILE="${GITHUB_WORKSPACE}/toolchains/gcc/bin/aarch64-linux-android-"
            export CLANG_TRIPLE=aarch64-linux-gnu-
            make O=out ARCH=${ARCH} a30s_defconfig.txt
            make -j"$(nproc)" O=out ARCH=${ARCH} \
              CC=clang CROSS_COMPILE=${CROSS_COMPILE} CLANG_TRIPLE=${CLANG_TRIPLE}
            make -j"$(nproc)" O=out ARCH=${ARCH} dtbs
            make -j"$(nproc)" O=out ARCH=${ARCH} modules

        - name: Package AnyKernel3 zip
          run: |
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AnyKernel3
            # Copy kernel artifacts
            cp out/arch/arm64/boot/Image AnyKernel3/
            [ -f out/arch/arm64/boot/dtb.img ] && cp out/arch/arm64/boot/dtb.img AnyKernel3/
            [ -f out/arch/arm64/boot/dtbo.img ] && cp out/arch/arm64/boot/dtbo.img AnyKernel3/
            # Configure AnyKernel3
            sed -i "s|^kernel.string=.*|kernel.string=${KERNEL_NAME}|" AnyKernel3/anykernel.sh
            sed -i "s|^do.devicecheck=.*|do.devicecheck=1|" AnyKernel3/anykernel.sh
            sed -i "s|^device.name1=.*|device.name1=a30s|" AnyKernel3/anykernel.sh
            sed -i "s|^IS_SLOT_DEVICE=.*|IS_SLOT_DEVICE=0|" AnyKernel3/anykernel.sh
            sed -i "s|^RAMDISK_COMPRESSION=.*|RAMDISK_COMPRESSION=none|" AnyKernel3/anykernel.sh
            sed -i "s|^BLOCK=.*|BLOCK=${BOOT_BLOCK}|" AnyKernel3/anykernel.sh
            sed -i "s|^DTB_PARTITION=.*|DTB_PARTITION=${DTB_BLOCK}|" AnyKernel3/anykernel.sh
            sed -i "s|^DTBO_PARTITION=.*|DTBO_PARTITION=${DTBO_BLOCK}|" AnyKernel3/anykernel.sh
            sed -i "s|^do.modules=.*|do.modules=1|" AnyKernel3/anykernel.sh
            ZIP_NAME="${KERNEL_NAME}-${GITHUB_SHA:0:7}.zip"
            cd AnyKernel3
            zip -r9 "../${ZIP_NAME}" * -x ".git/*" -x "README.md"

        - name: Upload artifacts
          uses: actions/upload-artifact@v4
          with:
            name: ${{ env.KERNEL_NAME }}
            path: |
              *.zip
              out/arch/arm64/boot/Image
              out/arch/arm64/boot/dtb.img
              out/arch/arm64/boot/dtbo.img

